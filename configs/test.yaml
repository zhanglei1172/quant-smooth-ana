# Test configuration for Quant Smooth Ana

# Model configuration
model:
  path: "/dataset/workspace/zhangl98/models/Qwen3-0.6B/"
  name: "Qwen3-0.6B"
  # family字段已移除，不再需要模型适配器

# Data configuration
data:
  source: "pile"  # pile, wikitext2, c4, redpajama, hf:dataset_name, custom:/path/to/file
  num_samples: 1
  seq_len: 256
  seed: 0
  # Custom dataset configuration
  custom:
    format: "text"  # text, json, csv
    text_column: "text"  # For JSON/CSV files

# Memory configuration
memory:
  device: "cuda"
  offload_device: "cpu"
  auto_offload: true

# Visualization configuration
visualization:
  save_dir: "./figures"
  dpi: 200
  show_legend: true
  
  # Output formats (complete report)
  output:
    formats: ["png", "html", "csv", "json"]
    report_name: "analysis_report"
    include_raw_data: true
  
  # Enabled visualizations
  enabled:
    magnitude_input: true
    magnitude_output: true
    magnitude_weight: true
    outlier_layer_wise: true
    outlier_position: true
    outlier_token: true
    heatmap_3d: true
    distribution: true
  
  # Magnitude configuration - 使用正则表达式匹配层
  magnitude:
    # 使用正则表达式patterns来选择要分析的层
    patterns:
      - "mlp\\.down_proj"   # 匹配所有down_proj层
      - "mlp\\.up_proj"     # 匹配所有up_proj层
      - "self_attn\\.q_proj"  # 匹配所有q_proj层
      - "self_attn\\.o_proj"  # 匹配所有o_proj层
    reduce_dim: -1 # -1 for in-channel(cross token), -2 for token
    combined_plot: true
  

  # Outlier configuration - 使用正则表达式匹配层
  outlier:
    threshold: 64  # Outlier threshold (relative to median)
    pattern: "mlp\\.down_proj"  # 使用正则匹配transformer层输出
    decode_tokens: true  # Whether to decode token content
  
  # Layer selection - 统一使用正则表达式
  # 这里配置的patterns会过滤所有分析（如果不配置，则分析所有匹配的层）
  layer_selection:
    # 使用正则表达式选择要分析的层
    patterns:
      - "layers\\.\\d+\\.mlp\\.down_proj"    # 所有down_proj层
      - "layers\\.\\d+\\.mlp\\.up_proj"      # 所有up_proj层
      - "layers\\.\\d+\\.self_attn\\.q_proj" # 所有q_proj层
      - "layers\\.\\d+\\.self_attn\\.o_proj" # 所有o_proj层
    
    # 正则表达式示例:
    # - "layers\\.[0-9]\\."           # 只匹配0-9层
    # - "layers\\.(0|5|10|15)\\."     # 只匹配特定层
    # - "model\\.layers\\.\\d+$"      # 匹配整个transformer层
    # - "language_model\\.model\\.layers\\.\\d+\\.mlp"  # VL模型的mlp层